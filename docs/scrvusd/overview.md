<h1>Savings crvUSD</h1>

Savings crvUSD, in short scrvUSD, is a savings version of crvUSD. 


---


# **Smart Contracts**

The Savings crvUSD system consists of multiple smart contracts:

<div class="grid cards" markdown>

-   :logos-vyper: `VaultV3.vy`

    ---

    The Vault contract is based on Yearn's `VaultV3.vy` contract, more precisely [version `3.0.4`](https://github.com/yearn/yearn-vaults-v3/blob/104a2b233bc6d43ba40720d68355b04d2dc31795/contracts/VaultV3.vy). It is an `ERC4626` compliant Vault that handles all logic associated with deposits, withdrawals, strategy management, profit reporting, etc.

    [:octicons-arrow-right-24: Yearn Dev Docs](https://docs.yearn.fi/developers/v3/overview)

-   :logos-vyper: `RewardsHandler.vy`

    ---

    The `RewardsHandler` contract is responsible for taking and storing snapshots of the ratio of crvUSD deposited into the Vault compared to the total circulating supply of crvUSD and calculating the time-weighted average of this ratio using the trapezoidal rule for interpolation. This value is then used to decide on the amount of rewards to "ask for" from the `FeeSplitter`. Calculation is done using a `TWA` module.
    

    [:octicons-arrow-right-24: Read more](./RewardsHandler.md)

-   :logos-vyper: `StablecoinLens.vy`

    ---

    Helper contract to calculate the true circulating supply of crvUSD by excluding e.g. unborrowed crvUSD from Controllers, crvUSD in PegKeep, etc.

    [:octicons-arrow-right-24: Read more](./StablecoinLens.md)

</div>

The documentation of the :logos-vyper: `FeeSplitter` contract can be found [here](https://docs.curve.fi/fees/FeeSplitter/).


---


# **Vault Implementation Details**

The Vault is an unmodified instance of the [Yearn V3 multi-strategy vault](https://github.com/yearn/yearn-vaults-v3) that accepts crvUSD deposits. The crvUSD deposited into the vault are not rehypothecated, they sit idle in the vault to earn yield.

This vault aims to be as cheap as possible for users to deposit and withdraw funds. For this reason funds deposited in the vault are not moved anywhere and are always available to be redeemed.

Although the vault is called "multi-strategy" it actually doesn't contain any strategies. This is possible thanks to yearn vaults' v3.0.3 ability to [report on self](https://github.com/yearn/yearn-vaults-v3/pull/205).


---


# **Rewards**

The Vault receives a dynamic percentage of the interest fees generated by the crvUSD from the `FeeSplitter` contract which is then distributed linearly across all depositors with respect to their share of the total deposits. Inbetween the `FeeSplitter` and the `Vault`, there is a `RewardsHandler` contract that handles the calculation of the dynamic percentage, which is determined by the ratio of crvUSD deposited into the vault over the total circulating supply of crvUSD.

<figure markdown="span">
  ![](../assets/images/stcrvusd/stcrvusd.svg){ width="2000" }
  <figcaption></figcaption>
</figure>


---


# **FeeSplitter Interaction and Weight Calculation**

For the `FeeSplitter` to send funds to the `RewardsHandler`, the `RewardsHandler` must be added as a receiver in the `FeeSplitter` by the DAO. Once this condition is met, the `FeeSplitter` will send funds to the `RewardsHandler` according to what the `weight` function in the `RewardsHandler` returns (this value is dynamic).

The `weight` function allows anyone to take snapshots of the ratio of crvUSD in the vault compared to the circulating supply of crvUSD. This ratio is used to determine the percentage of the fees that can be requested by the `FeeSplitter`.

For instance if the time-weighed average of the ratio is 0.1 (10% of the circulating supply is deposited into the vault), the `FeeSplitter` will request 10% of the fees generated by the crvUSD controllers.


---

# **Rewards Allocation**

Rewards allocated to scrvUSD come from crvUSD interest fees or any external donations sent to the `RewardsHandler` contract.

The ultimate amount of rewards is dynamic and is determined by the ratio of the staked supply to the total supply of crvUSD. Although it is dynamic, the weight has an upper and lower bound.

Rewards are distributed to scrvUSD holders thought the `RewardsHandler` contract using a simple `process_rewards` function. This function permnissionlessly lets anyone distribute rewards to the crvUSD vault.

<figure markdown="span">
  ![](../assets/images/stcrvusd/stcrvusd.svg){ width="2000" }
  <figcaption></figcaption>
</figure>

Although the weight is dynamic, it has a upper and lower bound:

1. The lower bound is defined in the `RewardsHandler` contract as `minimum_weight`. This is the minimum percentage of rewards that scrvUSD will receive.
2. The upper bound is defined in the `FeeSplitter` and represents the maximum percentage of rewards that scrvUSD will receive from the FeeSplitter. The FeeSplitter allows for dynamic weights, which is the case for scrvUSD. This upper value can be checked in the `FeeSplitter` contract by calling `FeeSplitter.receivers(i)`, where `i` is the index of the receiver. This method returns the address and the maximum weight of the receiver.

!!!example

    === "Example"

    The weight of the RewardsHandler is equals to 10%. Because the weight of the RewardsHandler is dynamic, these 10% serve as the maximum weight that the RewardsHandler can receive from the FeeSplitter.

    Now, the RewardsHandler contract does some calculations and determins the actual weight. The dynamic weight calculation is based on the ratio of the staked supply to the total supply of crvUSD and the `minimum_weight`. The contract will return the maximum of either the dynamic weight or the `minimum_weight`.

    Therefore, the weight allocated to the RewardsHandler contract will be somewhere in between `minimum_weight` and `10%`. If there is no value set for `minimum_weight`, this value will be treated as 0 meaning the dynamic weight is fully dependant on the ratio of the staked supply to the total supply of crvUSD. 

    For more informations about the calcuation of the dynamic weight, check the [RewardsHandler contract](./RewardsHandler.md).
